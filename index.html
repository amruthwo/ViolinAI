<!doctype html>
<html lang="en" data-theme="dark" data-design="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>ViolinAI â€” Falling Notes</title>

  <style>
    :root{
      /* Core tokens (overridden by Material seed + Liquid theme) */
      --bg:#0d1020;
      --bgFX:none;
      --surface:#141836;
      --surface2:#181d41;
      --canvas:#0f1330;
      --lane:#121843;
      --border:rgba(255,255,255,.18);
      --text:#f2f4ff;
      --muted:rgba(242,244,255,.72);

      --accent:#5b8cff;      /* changes with Material seed */
      --accent2:#ff5bd6;     /* secondary/tertiary vibe */
      --accent3:#23d1b5;
      --accent4:#ffb020;

      --shadow: 0 10px 28px rgba(0,0,0,.40);
      --shadow2: 0 6px 18px rgba(0,0,0,.32);

      --radius:18px;
      --radius2:14px;

      --pillH:44px;
      --pillPadX:16px;

      --btnText:#0c1024;
      --btnFill: var(--accent);
      --btnFill2: color-mix(in srgb, var(--accent) 18%, transparent);
      --btnBorder: color-mix(in srgb, var(--accent) 34%, var(--border));

      --danger:#ff4d6d;

      --gridGap:12px;

      --sheetMinSpacing: 58px; /* increased spacing */
      --sheetWrapPadding: 18px;

      --fallingMinGap: 64px;   /* vertical padding between falling notes */
    }

    /* Light mode baseline */
    html[data-theme="light"]{
      --bg:#f7f8ff;
      --surface:#ffffff;
      --surface2:#f1f3ff;
      --canvas:#ffffff;
      --lane:#f3f5ff;
      --border:rgba(0,0,0,.12);
      --text:#0b1026;
      --muted:rgba(11,16,38,.60);
      --shadow: 0 10px 28px rgba(0,0,0,.10);
      --shadow2: 0 6px 18px rgba(0,0,0,.08);

      --btnText:#0b1026;
      --btnFill: var(--accent);
      --btnFill2: color-mix(in srgb, var(--accent) 14%, transparent);
      --btnBorder: color-mix(in srgb, var(--accent) 30%, var(--border));
    }

    /* Layout */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
      background-image: var(--bgFX);
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: var(--gridGap);
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .brand .tag{
      font-weight:800;
      font-size:12px;
      opacity:.75;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: color-mix(in srgb, var(--surface) 72%, transparent);
    }

    /* Cards / panels */
    .card{
      background: color-mix(in srgb, var(--surface) 86%, transparent);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 76%, transparent);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
    }
    .card .bd{
      padding: 12px 14px;
    }

    /* Buttons */
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      position:relative;
      appearance:none;
      border:1px solid var(--btnBorder);
      background: var(--btnFill2);
      color: var(--text);
      height: var(--pillH);
      padding: 0 var(--pillPadX);
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btn.primary{
      background: var(--btnFill);
      color: var(--btnText);
      border-color: color-mix(in srgb, var(--btnFill) 65%, var(--border));
    }
    .btn.danger{
      background: color-mix(in srgb, var(--danger) 80%, transparent);
      border-color: color-mix(in srgb, var(--danger) 55%, var(--border));
      color: #fff;
    }
    .btn .ico{
      width:18px;height:18px;display:inline-block;flex:0 0 18px;
    }
    .btn.big{
      height: calc(var(--pillH) * 1.5);
      padding: 0 calc(var(--pillPadX) * 1.25);
      font-size: 16px;
    }

    /* Segmented control (equal widths) */
    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      height: var(--pillH);
      background: color-mix(in srgb, var(--surface2) 70%, transparent);
      box-shadow: var(--shadow2);
    }
    .seg button{
      flex:1 1 0;
      border:0;
      background: transparent;
      color: var(--text);
      font-weight: 900;
      letter-spacing:.2px;
      cursor:pointer;
      padding:0 16px;
    }
    .seg button.active{
      background: var(--btnFill);
      color: var(--btnText);
    }

    /* Check toggles (pill) */
    .chkPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      height: var(--pillH);
      padding: 0 var(--pillPadX);
      border-radius: 999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--surface2) 70%, transparent);
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .chkPill input{ transform: scale(1.1); }

    /* File input */
    .file{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="file"]{
      max-width: 260px;
    }

    /* Settings drawer */
    .settingsBtn{
      width: var(--pillH);
      padding:0;
    }
    #settingsPanel[hidden]{ display:none; }

    /* Readout (collapsible) */
    details{
      border-radius: var(--radius);
    }
    summary{
      cursor:pointer;
      list-style:none;
      font-weight:900;
      padding: 10px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 76%, transparent);
      background: color-mix(in srgb, var(--surface2) 66%, transparent);
    }
    summary::-webkit-details-marker{ display:none; }
    .readoutGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 10px 12px;
    }
    .kv{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding:10px;
      background: color-mix(in srgb, var(--surface) 82%, transparent);
    }
    .kv .k{ font-size:12px; opacity:.75; font-weight:800; }
    .kv .v{ font-size:14px; font-weight:900; margin-top:6px; word-break:break-word; }

    /* Two-panel responsive layout */
    .mainGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gridGap);
    }
    @media (min-width: 900px){
      .mainGrid{
        grid-template-columns: 1.05fr 0.95fr;
        align-items:start;
      }
      .wrap{ padding: 18px; }
    }

    /* Canvases */
    canvas{
      display:block;
      width:100%;
      height:auto;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: var(--canvas);
    }

    /* Sheet: vertical scroll allowed, no horizontal scroll */
    #sheetScroll{
      overflow-x:hidden;
      overflow-y:auto;
      max-height: 54vh;
    }
    @media (max-width: 520px){
      #sheetScroll{ max-height: 44vh; }
    }

    /* Status row */
    .statusRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      font-size: 12px;
      opacity:.85;
      padding: 10px 14px;
      border-top:1px solid color-mix(in srgb, var(--border) 76%, transparent);
      background: color-mix(in srgb, var(--surface2) 70%, transparent);
    }
    .statusRow code{ font-weight:900; }

    /* Seed dots */
    .seedDots{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .seedDot{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid color-mix(in srgb, var(--border) 70%, transparent);
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .seedDot.active{
      outline: 3px solid color-mix(in srgb, var(--accent) 50%, transparent);
      outline-offset: 2px;
    }

    /* Ripple ink */
    .ripple-ink{
      position:absolute;
      border-radius: 999px;
      transform: scale(0);
      background: color-mix(in srgb, #fff 36%, transparent);
      opacity:.9;
      pointer-events:none;
      animation: ripple .52s ease-out forwards;
      mix-blend-mode: overlay;
    }
    @keyframes ripple{
      to{ transform: scale(1); opacity:0; }
    }

    /* Design: Classic */
    html[data-design="classic"]{
      --bgFX:none;
      --btnFill2: color-mix(in srgb, var(--surface2) 70%, transparent);
      --btnBorder: var(--border);
    }

    /* Design: Liquid Glass (more vivid, shimmer sweep uses CSS only) */
    html[data-design="liquid"]{
      --accent: #ff4fd8;
      --accent2:#7a5cff;
      --accent3:#24f0c7;
      --accent4:#ffb020;
      --bgFX:
        radial-gradient(560px 460px at 14% 10%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 70%),
        radial-gradient(620px 520px at 90% 20%, color-mix(in srgb, var(--accent2) 18%, transparent), transparent 70%),
        radial-gradient(760px 560px at 60% 110%, color-mix(in srgb, var(--accent3) 14%, transparent), transparent 70%);
      --btnFill: linear-gradient(135deg, color-mix(in srgb, var(--accent) 92%, #fff 8%), color-mix(in srgb, var(--accent2) 78%, #fff 22%));
      --btnText: #0b1026;
      --btnBorder: color-mix(in srgb, var(--accent2) 34%, var(--border));
      --btnFill2: color-mix(in srgb, #fff 10%, transparent);
    }
    html[data-design="liquid"] .btn.primary{
      position:relative;
      overflow:hidden;
    }
    html[data-design="liquid"] .btn.primary::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(120deg,
        transparent 10%,
        rgba(255,255,255,.35) 30%,
        transparent 55%);
      transform: translateX(-65%) rotate(8deg);
      animation: shimmer 2.3s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-80%) rotate(8deg); opacity:.0; }
      18%{ opacity:.55; }
      50%{ opacity:.35; }
      100%{ transform: translateX(80%) rotate(8deg); opacity:0; }
    }

    /* Design: Material 3 (seed colors injected into --accent/2/3/4 and surfaces) */
    html[data-design="material"]{
      --btnFill: var(--accent);
      --btnText: color-mix(in srgb, #000 84%, transparent);
      --btnFill2: color-mix(in srgb, var(--accent) 14%, transparent);
      --btnBorder: color-mix(in srgb, var(--accent) 26%, var(--border));
    }

    /* Responsive: hide settings panel by default on phones (JS will also handle) */
    @media (max-width: 640px){
      .readoutGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div>ViolinAI</div>
        <div class="tag">v13</div>
      </div>
      <button id="settingsBtn" class="btn settingsBtn ripple" title="Settings" aria-expanded="false">
        <!-- gear icon -->
        <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15a8.6 8.6 0 0 0 .1-6l-2 0-.6-1.5 1.4-1.4a10 10 0 0 0-4.2-2.4L13 5l-2 0-.9-1.8A10 10 0 0 0 5.9 5.6L7.3 7 6.7 8.5l-2 0a8.6 8.6 0 0 0 0 6l2 0 .6 1.5-1.4 1.4a10 10 0 0 0 4.2 2.4L11 19l2 0 .9 1.8a10 10 0 0 0 4.2-2.4L16.7 17l.6-1.5 2 0Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div id="settingsPanel" class="card" hidden>
      <div class="hd">
        <div style="font-weight:900;">Controls</div>
        <div class="pillRow">
          <button id="themeBtn" class="btn ripple">ðŸŒ™ Dark</button>
          <select id="designSelect" class="btn ripple" style="height:var(--pillH);">
            <option value="auto">Auto</option>
            <option value="material">Material 3</option>
            <option value="liquid">Liquid Glass</option>
            <option value="classic">Classic</option>
          </select>
        </div>
      </div>

      <div class="bd">
        <div class="file">
          <label style="font-weight:900;">Choose File:</label>
          <input id="scoreFile" type="file" accept=".mid,.midi,.xml,.musicxml" />
          <span style="opacity:.8;">Source: <code id="srcTxt">â€”</code></span>
          <span style="opacity:.8;">Key: <code id="keyTxt">â€”</code></span>
        </div>

        <div style="height:12px;"></div>

        <div class="pillRow">
          <div class="seg" style="min-width: 220px;">
            <button id="modePreview" class="active">Preview</button>
            <button id="modeLearn">Learn</button>
          </div>

          <label class="chkPill">
            <input id="showSheet" type="checkbox" checked />
            <span style="font-weight:900;">Sheet</span>
          </label>
          <label class="chkPill">
            <input id="showFalling" type="checkbox" checked />
            <span style="font-weight:900;">Falling</span>
          </label>

          <span id="m3SeedLine" style="flex-basis:100%; height:1px; background: color-mix(in srgb, var(--border) 76%, transparent); display:none;"></span>

          <div id="m3SeedControls" style="display:flex; align-items:center; gap:10px;" hidden>
            <div class="seedDots" id="m3SeedDots"></div>
            <button id="m3ShuffleBtn" class="btn ripple">Shuffle</button>
            <span style="opacity:.85;">Seed: <code id="m3SeedTxt">â€”</code></span>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="pillRow">
          <button id="previewPlayBtn" class="btn big primary ripple">
            <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            Play
          </button>
          <button id="previewPauseBtn" class="btn big ripple">
            <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
            Pause
          </button>
          <button id="previewStopBtn" class="btn big ripple">
            <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
            Stop
          </button>
          <button id="testSoundBtn" class="btn big ripple">
            <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4h4l5 4V6L7 10zm13.5 2a3.5 3.5 0 0 0-2.5-3.35v6.7A3.5 3.5 0 0 0 16.5 12zm0-7a8.5 8.5 0 0 1 0 14v-2a6.5 6.5 0 0 0 0-10z"/></svg>
            Test
          </button>
          <button id="startMicBtn" class="btn big primary ripple" style="display:none;">
            <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11z"/></svg>
            Start Mic
          </button>
        </div>

        <div style="height:12px;"></div>

        <details class="card" open>
          <summary>Practice &amp; timing</summary>
          <div class="bd">
            <div class="pillRow">
              <button id="tempoDownBtn" class="btn ripple">â—€ï¸Ž Speed</button>
              <span class="btn" style="cursor:default;">Tempo: <code id="tempoVal">1.00Ã—</code></span>
              <button id="tempoUpBtn" class="btn ripple">Speed â–¶ï¸Ž</button>

              <label class="chkPill">
                <span style="font-weight:900;">Count-in</span>
                <input id="countIn" type="number" min="0" max="8" value="0" style="width:64px;" />
              </label>

              <label class="chkPill">
                <input id="metroOn" type="checkbox" />
                <span style="font-weight:900;">Metronome</span>
              </label>

              <button id="loopStartBtn" class="btn ripple">Set Start</button>
              <button id="loopEndBtn" class="btn ripple">Set End</button>
              <button id="loopClearBtn" class="btn danger ripple">Clear</button>

              <span class="btn" style="cursor:default;"><code id="loopRead">Loop: off</code></span>
            </div>

            <div id="learnOnlyRow" style="display:none; margin-top:12px;">
              <div class="pillRow">
                <label class="chkPill">
                  <span style="font-weight:900;">Tolerance (cents)</span>
                  <input id="tolCents" type="number" min="10" max="80" value="35" style="width:74px;" />
                </label>
                <label class="chkPill">
                  <input id="waitMode" type="checkbox" checked />
                  <span style="font-weight:900;">Require stable note</span>
                </label>
              </div>
            </div>
          </div>
        </details>

        <div style="height:12px;"></div>

        <details id="readoutDetails" class="card">
          <summary>Target / heard</summary>
          <div class="readoutGrid">
            <div class="kv">
              <div class="k">Target</div>
              <div class="v" id="targetTxt">â€”</div>
            </div>
            <div class="kv">
              <div class="k">Heard</div>
              <div class="v" id="heardTxt">â€”</div>
            </div>
            <div class="kv">
              <div class="k">Clarity</div>
              <div class="v" id="clarityTxt">â€”</div>
            </div>
            <div class="kv">
              <div class="k">Delta</div>
              <div class="v" id="deltaTxt">â€”</div>
            </div>
          </div>
        </details>
      </div>

      <div class="statusRow">
        <div id="status">Loadingâ€¦</div>
        <div style="opacity:.8;">Tip: iPhone silent switch can mute preview audio.</div>
      </div>
    </div>

    <div class="mainGrid">
      <div id="sheetPanel" class="card">
        <div class="hd"><div style="font-weight:900;">Sheet Music</div></div>
        <div class="bd" id="sheetScroll">
          <canvas id="sheetCanvas"></canvas>
        </div>
      </div>

      <div id="fallingPanel" class="card">
        <div class="hd"><div style="font-weight:900;">Falling Notes</div></div>
        <div class="bd">
          <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pitchy@4.1.0/dist/pitchy.umd.min.js"></script>

  <!-- App -->
  <script type="module" src="app.js?v=13"></script>
</body>
</html>
