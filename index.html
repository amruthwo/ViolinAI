<!doctype html>
<html lang="en" data-theme="dark" data-design="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Violin Falling Notes (PWA)</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="stylesheet" href="style.css?v=12" />
</head>
<body>

  <!-- Inline SVG icon sprite -->
  <svg class="svg-sprite" aria-hidden="true" focusable="false">
    <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l12-7z"></path></symbol>
    <symbol id="i-pause" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"></path></symbol>
    <symbol id="i-stop" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></symbol>
    <symbol id="i-volume" viewBox="0 0 24 24">
      <path d="M4 10v4h3l4 4V6L7 10H4z"></path>
      <path d="M16.5 12a3.5 3.5 0 0 0-2-3.15v6.3a3.5 3.5 0 0 0 2-3.15z"></path>
      <path d="M14.5 4.4v2.2A6.5 6.5 0 0 1 18 12a6.5 6.5 0 0 1-3.5 5.4v2.2A8.7 8.7 0 0 0 20.2 12a8.7 8.7 0 0 0-5.7-7.6z"></path>
    </symbol>
    <symbol id="i-mic" viewBox="0 0 24 24">
      <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"></path>
      <path d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 0 0-2 0 7 7 0 0 0 6 6.92V20H9a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2h-2v-2.08A7 7 0 0 0 19 11z"></path>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24">
      <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.1 7.1 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 12.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.57.23-1.11.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L1.71 7.98a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L1.83 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.23.4.32.64.22l2.39-.96c.52.4 1.06.71 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.57-.23 1.11-.54 1.63-.94l2.39.96c.24.1.51.01.64-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM11 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path>
    </symbol>
    <symbol id="i-shuffle" viewBox="0 0 24 24">
      <path d="M16 3h5v5h-2V6.41l-3.29 3.3-1.42-1.42 3.3-3.29H16V3zM4 7h6v2H4V7zm0 8h6v2H4v-2zm16.59 2.59-3.3-3.3 1.42-1.42 3.29 3.29V15h2v5h-5v-2h1.59zM13.41 12.59 11 10.17V8.76l3.83 3.83-1.42 1.42z"></path>
    </symbol>
    <symbol id="i-chevron" viewBox="0 0 24 24">
      <path d="M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path>
    </symbol>
  </svg>

  <div class="app">
    <header class="topbar" id="topbar">
      <div class="brand">
        <div class="title">Violin Falling Notes</div>
        <div class="subtitle">MIDI / MusicXML â€¢ Preview (listen) â€¢ Learn (play-to-advance)</div>
      </div>

      <div class="transport">
        <button id="previewPlayBtn" class="btn btn-primary btn-icon ripple" disabled aria-label="Play">
          <svg><use href="#i-play"></use></svg>
        </button>
        <button id="previewPauseBtn" class="btn btn-tonal btn-icon ripple" disabled aria-label="Pause">
          <svg><use href="#i-pause"></use></svg>
        </button>
        <button id="previewStopBtn" class="btn btn-ghost btn-icon ripple" disabled aria-label="Stop">
          <svg><use href="#i-stop"></use></svg>
        </button>
        <button id="testSoundBtn" class="btn btn-ghost btn-icon ripple" disabled aria-label="Test sound">
          <svg><use href="#i-volume"></use></svg>
        </button>
        <button id="startMicBtn" class="btn btn-primary btn-icon ripple" disabled aria-label="Start microphone">
          <svg><use href="#i-mic"></use></svg>
        </button>

        <button id="settingsBtn" class="btn btn-ghost btn-icon btn-gear ripple"
          aria-expanded="false" aria-controls="settingsPanel" title="Settings" aria-label="Settings">
          <svg><use href="#i-gear"></use></svg>
        </button>
      </div>

      <section id="settingsPanel" class="settings" hidden>
        <div class="settingsGrid">
          <label class="filePick">
            <span>Score</span>
            <input id="scoreFile" type="file" accept=".mid,.midi,.musicxml,.xml" />
          </label>

          <div class="seg" role="tablist" aria-label="Mode">
            <button id="modePreview" class="segbtn active ripple" type="button">Preview</button>
            <button id="modeLearn" class="segbtn ripple" type="button">Learn</button>
          </div>

          <div class="toggleRow">
            <label class="chip chip-pill"><input id="showSheet" type="checkbox" checked> Sheet</label>
            <label class="chip chip-pill"><input id="showFalling" type="checkbox" checked> Falling</label>
          </div>

          <div class="selectRow">
            <label class="select">
              <span>Design</span>
              <select id="designSelect">
                <option value="auto">Auto</option>
                <option value="liquid">Liquid Glass</option>
                <option value="material">Material 3</option>
                <option value="classic">Classic</option>
              </select>
            </label>

            <!-- Material-only: seed dots + shuffle -->
            <div id="m3SeedControls" class="seedControls" hidden>
              <div class="seedDots" id="m3SeedDots" aria-label="Material seed colors"></div>
              <button id="m3ShuffleBtn" class="btn btn-tonal btn-pill ripple" type="button" title="Shuffle Material seed color">
                <svg class="ico"><use href="#i-shuffle"></use></svg>
                <span>Shuffle</span>
              </button>
            </div>

            <button id="themeBtn" class="btn btn-tonal ripple" title="Toggle light/dark">ðŸŒ™ Dark</button>
          </div>
        </div>

        <details class="advanced" open>
          <summary>Practice & timing</summary>

          <div class="row row-tight">
            <div class="tempoBox">
              <span class="label">Tempo</span>
              <button id="tempoDownBtn" class="btn btn-ghost btn-pill ripple" disabled>âˆ’</button>
              <span id="tempoVal" class="tempoVal">1.00Ã—</span>
              <button id="tempoUpBtn" class="btn btn-ghost btn-pill ripple" disabled>+</button>
            </div>

            <label class="inline">Count-in (beats):
              <input id="countIn" type="number" min="0" max="8" step="1" value="4">
            </label>

            <label class="btn btn-ghost btn-pill chiplike">
              <input id="metroOn" type="checkbox">
              <span>Metronome</span>
            </label>

            <div class="loopRow">
              <button id="loopStartBtn" class="btn btn-ghost btn-pill ripple" disabled>âŸ² Start</button>
              <button id="loopEndBtn" class="btn btn-ghost btn-pill ripple" disabled>âŸ³ End</button>
              <button id="loopClearBtn" class="btn btn-ghost btn-pill ripple" disabled>âœ• Clear</button>
              <span class="pill" id="loopRead">Loop: off</span>
            </div>
          </div>

          <div class="row row-tight learnOnly" id="learnOnlyRow">
            <label class="inline">Tolerance (cents):
              <input id="tolCents" type="number" min="10" max="80" step="1" value="35">
            </label>
            <label class="btn btn-ghost btn-pill chiplike">
              <input id="waitMode" type="checkbox" checked>
              <span>Wait mode</span>
            </label>
          </div>
        </details>
      </section>

      <div class="status" id="status">Load a MIDI or MusicXML file to begin.</div>

      <!-- Collapsible readout (critical for phone usability) -->
      <details class="readoutDetails" id="readoutDetails" open>
        <summary class="readoutSummary">
          <span>Target / Mic / Key</span>
          <svg class="chev"><use href="#i-chevron"></use></svg>
        </summary>
        <div class="readout" id="readout">
          <div><b>Target:</b> <span id="targetTxt">â€”</span></div>
          <div><b>Heard:</b> <span id="heardTxt">â€”</span></div>
          <div><b>Clarity:</b> <span id="clarityTxt">â€”</span></div>
          <div><b>Delta:</b> <span id="deltaTxt">â€”</span></div>
          <div><b>Key:</b> <span id="keyTxt">â€”</span></div>
          <div><b>Source:</b> <span id="srcTxt">â€”</span></div>
          <div id="m3SeedLine" style="opacity:.85"><b>M3 seed:</b> <span id="m3SeedTxt">â€”</span></div>
        </div>
      </details>
    </header>

    <main class="stageGrid" id="stageGrid">
      <section class="panel" id="sheetPanel">
        <div class="panelHdr">
          <div>
            <div class="panelTitle">Sheet</div>
            <div class="panelHint">Simplified notation view (scrollable)</div>
          </div>
        </div>

        <!-- Scroll container so we can make sheet "wider than screen" -->
        <div class="canvasScroll" id="sheetScroll">
          <canvas id="sheetCanvas"></canvas>
        </div>
      </section>

      <section class="panel" id="fallingPanel">
        <div class="panelHdr">
          <div>
            <div class="panelTitle">Falling Notes</div>
            <div class="panelHint">String lanes + finger hints</div>
          </div>
        </div>
        <canvas id="canvas"></canvas>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pitchy@4.1.0/dist/pitchy.umd.min.js"></script>

  <script type="module" src="app.js?v=12"></script>
</body>
</html>
